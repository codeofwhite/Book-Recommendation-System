version: '3.8'

services:
  # --- Auth Service ---
  auth_db:
    image: mysql:8.0
    container_name: auth_mysql_db
    environment:
      MYSQL_ROOT_PASSWORD: your_auth_root_password # 为每个数据库设置不同的密码
      MYSQL_DATABASE: auth_db # 独立的 Auth 数据库
      MYSQL_USER: auth_user
      MYSQL_PASSWORD: auth_password
    command:
      - --default-authentication-plugin=mysql_native_password
    ports:
      - "3307:3306" # Auth DB 映射到宿主机的 3307 端口，避免与 Book DB 冲突
    volumes:
      - auth_mysql_data:/var/lib/mysql
    healthcheck: # 为数据库添加健康检查，确保服务完全可用才启动依赖它的服务
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
      interval: 10s

  auth_service:
    build: ./auth_service # 指向 auth_service 目录的 Dockerfile
    ports:
      - "5000:5000" # Auth Service 暴露在 5000 端口
    environment:
      DB_HOST: auth_db # 连接到 auth_db 服务
      DB_USER: auth_user
      DB_PASSWORD: auth_password
      DB_NAME: auth_db
    depends_on:
      auth_db:
        condition: service_healthy # 确保 auth_db 健康后再启动 auth_service

  # --- Book Management Service (将使用 MongoDB) ---
  book_db_mongo: # 新的 MongoDB 服务名称
    image: mongo:latest # 使用最新的 MongoDB 镜像
    container_name: book_mongo_db
    environment:
      MONGO_INITDB_ROOT_USERNAME: book_user # MongoDB 管理员用户名
      MONGO_INITDB_ROOT_PASSWORD: book_password # MongoDB 管理员密码
      MONGO_INITDB_DATABASE: book_manage_db # 初始数据库
    ports:
      - "27017:27017" # MongoDB 默认端口
    volumes:
      - book_mongo_data:/data/db # MongoDB 数据持久化
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "--quiet", "-u", "book_user", "-p", "book_password", "--authenticationDatabase", "admin"]
      interval: 5s
      timeout: 5s
      retries: 10

  book_manage:
    build: ./book_manage # 指向 book_manage 目录的 Dockerfile
    ports:
      - "5001:5001" # Book Management Service 暴露在 5001 端口
    environment:
      MONGO_HOST: book_db_mongo  # 修改为 MONGO_ 前缀
      MONGO_USER: book_user
      MONGO_PASSWORD: book_password
      MONGO_DB_NAME: book_manage_db
    depends_on:
      book_db_mongo:
        condition: service_healthy # 确保 MongoDB 健康后再启动 book_manage

volumes:
  auth_mysql_data: # 为 Auth DB 创建持久化数据卷
  book_mongo_data: # 为 Book Management DB 创建持久化数据卷